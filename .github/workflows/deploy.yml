name: Deploy to Firebase Hosting

on:
  push:
    branches:
      - main
  pull_request:
    branches:
      - main

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Create Firebase config
        run: |
          mkdir -p src/config
          cat > src/config/firebase.ts << 'EOF'
          import { initializeApp } from 'firebase/app';
          import { getAnalytics, isSupported, type Analytics } from 'firebase/analytics';
          import {
            browserLocalPersistence,
            getAuth,
            GoogleAuthProvider,
            setPersistence,
            type Auth,
          } from 'firebase/auth';
          import { getFirestore, type Firestore } from 'firebase/firestore';

          const firebaseConfig = {
            apiKey: '${{ secrets.VITE_FIREBASE_API_KEY }}',
            authDomain: '${{ secrets.VITE_FIREBASE_AUTH_DOMAIN }}',
            projectId: '${{ secrets.VITE_FIREBASE_PROJECT_ID }}',
            storageBucket: '${{ secrets.VITE_FIREBASE_STORAGE_BUCKET }}',
            messagingSenderId: '${{ secrets.VITE_FIREBASE_MESSAGING_SENDER_ID }}',
            appId: '${{ secrets.VITE_FIREBASE_APP_ID }}',
            measurementId: '${{ secrets.VITE_FIREBASE_MEASUREMENT_ID }}',
          };

          const app = initializeApp(firebaseConfig);

          let analytics: Analytics | undefined;

          if (typeof window !== 'undefined') {
            void isSupported().then((supported) => {
              if (supported) {
                analytics = getAnalytics(app);
              }
            });
          }

          const auth: Auth = getAuth(app);
          const googleProvider = new GoogleAuthProvider();

          void setPersistence(auth, browserLocalPersistence).catch(() => {
            // Fallback to default persistence when browser persistence cannot be set.
          });

          const db: Firestore = getFirestore(app);

          export { app, analytics, auth, googleProvider, db };
          EOF

      - name: Build project
        run: npm run build

      - name: Deploy to Firebase Hosting
        uses: FirebaseExtended/action-hosting-deploy@v0
        with:
          repoToken: '${{ secrets.GITHUB_TOKEN }}'
          firebaseServiceAccount: '${{ secrets.FIREBASE_SERVICE_ACCOUNT }}'
          channelId: live
          projectId: ${{ secrets.VITE_FIREBASE_PROJECT_ID }}
